<div class="w-full max-w-full modal-content-wrapper">
  <h2 class="text-2xl text-main font-medium">Ajouter une collecte</h2>
  <p>Sélectionnez un contribuable et ses taxes</p>
  
  @if (error) {
    <div class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
      {{ error }}
    </div>
  }
  
  <form class="w-full grid gap-6 mt-8" (ngSubmit)="onSubmit()">
    <!-- Contribuable Selection -->
    <div>
      <label for="contribuable_id" class="block text-sm/6 font-medium text-gray-900">
        Contribuable <sup class="text-red-500">*</sup>
      </label>
      <div class="mt-2">
        <select 
          name="contribuable_id" 
          id="contribuable_id" 
          [(ngModel)]="formData.contribuable_id"
          (change)="onContribuableChange()"
          required
          [disabled]="loadingContribuables"
          class="block w-full rounded-lg px-3 py-3 bg-background text-base text-gray-900 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main sm:text-sm/6"
        >
          <option [value]="0">Sélectionner un contribuable</option>
          @for (contribuable of contribuables; track contribuable.id) {
            <option [value]="contribuable.id">
              {{ contribuable.nom }} {{ contribuable.prenom || '' }} 
              @if (contribuable.telephone) {
                - {{ contribuable.telephone }}
              }
            </option>
          }
        </select>
        @if (loadingContribuables) {
          <p class="mt-1 text-xs text-gray-500">Chargement des contribuables...</p>
        }
      </div>
    </div>

    <!-- Info Contribuable Card -->
    @if (selectedContribuable && !loadingTaxes) {
      <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <h3 class="text-lg font-semibold text-main mb-3">Informations du contribuable</h3>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div>
            <p class="text-gray-600">Nom</p>
            <p class="font-medium">{{ selectedContribuable.nom }}</p>
          </div>
          <div>
            <p class="text-gray-600">Prénom</p>
            <p class="font-medium">{{ selectedContribuable.prenom || '-' }}</p>
          </div>
          <div>
            <p class="text-gray-600">Téléphone</p>
            <p class="font-medium">{{ selectedContribuable.telephone }}</p>
          </div>
          <div>
            <p class="text-gray-600">Email</p>
            <p class="font-medium">{{ selectedContribuable.email || '-' }}</p>
          </div>
          @if (selectedContribuable.adresse) {
            <div class="col-span-2">
              <p class="text-gray-600">Adresse</p>
              <p class="font-medium">{{ selectedContribuable.adresse }}</p>
            </div>
          }
        </div>
      </div>
    }

    <!-- Taxes Disponibles -->
    @if (selectedContribuable) {
      <div>
        <label class="block text-sm/6 font-medium text-gray-900 mb-3">
          Taxes actives <sup class="text-red-500">*</sup>
        </label>
        
        @if (loadingTaxes) {
          <p class="text-center py-4 text-gray-500">Chargement des taxes...</p>
        } @else if (taxesDisponibles.length === 0) {
          <p class="text-center py-4 text-gray-500">Aucune taxe active pour ce contribuable</p>
        } @else {
          <div class="space-y-2 border border-gray-200 rounded-lg p-4 bg-gray-50 max-h-64 overflow-y-auto">
            @for (taxe of taxesDisponibles; track taxe.affectation_id) {
              <div class="flex items-center p-2 hover:bg-gray-100 rounded">
                <input 
                  type="checkbox" 
                  [id]="'taxe_' + taxe.affectation_id"
                  [(ngModel)]="taxe.selected"
                  [name]="'taxe_' + taxe.affectation_id"
                  (change)="onTaxeSelectionChange()"
                  class="rounded border-gray-300"
                />
                <label [for]="'taxe_' + taxe.affectation_id" class="ml-3 flex-1 cursor-pointer">
                  <div class="flex justify-between items-start">
                    <div>
                      <p class="font-medium text-gray-900">{{ taxe.taxe_nom }}</p>
                      <p class="text-xs text-gray-500">
                        {{ taxe.taxe_code }} • {{ taxe.periodicite }}
                        @if (taxe.description) {
                          - {{ taxe.description }}
                        }
                      </p>
                    </div>
                    <div class="text-right">
                      <p class="font-semibold text-main">
                        {{ taxe.montant_custom || taxe.montant | number:'1.2-2' }} XAF
                      </p>
                    </div>
                  </div>
                </label>
              </div>
            }
          </div>
        }
      </div>

      <!-- Montant Total -->
      @if (montantTotal > 0) {
        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
          <div class="flex justify-between items-center">
            <p class="text-lg font-semibold text-gray-900">Montant Total</p>
            <p class="text-2xl font-bold text-main">{{ montantTotal | number:'1.2-2' }} XAF</p>
          </div>
          <p class="text-xs text-gray-600 mt-1">
            Vous avez sélectionné {{ formData.items.length }} taxe(s)
          </p>
        </div>
      }
    }

    <!-- Collecteur (auto-rempli) -->
    @if (selectedContribuable) {
      <div>
        <label for="collecteur_id" class="block text-sm/6 font-medium text-gray-900">
          Collecteur <sup class="text-red-500">*</sup>
        </label>
        <div class="mt-2">
          <select 
            name="collecteur_id" 
            id="collecteur_id" 
            [(ngModel)]="formData.collecteur_id"
            required
            [disabled]="loadingCollecteurs"
            class="block w-full rounded-lg px-3 py-3 bg-blue-50 text-base text-gray-900 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main sm:text-sm/6"
          >
            <option [value]="0">Sélectionner un collecteur</option>
            @for (collecteur of collecteurs; track collecteur.id) {
              <option [value]="collecteur.id">
                {{ collecteur.nom }} {{ collecteur.prenom || '' }}
                @if (collecteur.matricule) {
                  ({{ collecteur.matricule }})
                }
              </option>
            }
          </select>
          <p class="mt-1 text-xs text-gray-500">Pré-rempli selon les données du contribuable</p>
          @if (loadingCollecteurs) {
            <p class="mt-1 text-xs text-gray-500">Chargement des collecteurs...</p>
          }
        </div>
      </div>
    }

    <!-- Type de Paiement -->
    <div>
      <label for="type_paiement" class="block text-sm/6 font-medium text-gray-900">
        Type de paiement <sup class="text-red-500">*</sup>
      </label>
      <div class="mt-2">
        <select 
          name="type_paiement" 
          id="type_paiement" 
          [(ngModel)]="formData.type_paiement"
          required
          class="block w-full rounded-lg px-3 py-3 bg-background text-base text-gray-900 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main sm:text-sm/6"
        >
          <option value="especes">Espèces</option>
          <option value="mobile_money">Mobile Money</option>
          <option value="carte">Carte bancaire</option>
        </select>
      </div>
    </div>

    <!-- Date de Collecte -->
    <div>
      <label for="date_collecte" class="block text-sm/6 font-medium text-gray-900">
        Date de la collecte
      </label>
      <div class="mt-2">
        <input 
          type="date" 
          name="date_collecte" 
          id="date_collecte" 
          [(ngModel)]="formData.date_collecte"
          class="block w-full rounded-lg px-3 py-3 bg-background text-base text-gray-900 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main sm:text-sm/6"
        />
      </div>
    </div>

    <!-- Billetage -->
    <div>
      <label for="billetage" class="block text-sm/6 font-medium text-gray-900">
        Billetage (JSON)
      </label>
      <div class="mt-2">
        <textarea 
          name="billetage" 
          id="billetage" 
          [(ngModel)]="formData.billetage"
          placeholder="Ex: {&quot;5000&quot;: 5, &quot;1000&quot;: 10}"
          rows="3"
          class="block w-full rounded-lg px-3 py-3 bg-background text-base text-gray-900 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main sm:text-sm/6"
        ></textarea>
        <p class="mt-1 text-xs text-gray-500">Optionnel - Détail du billetage en JSON</p>
      </div>
    </div>

    <!-- Buttons -->
    <div class="flex gap-3 justify-end mt-8">
      <button 
        type="button"
        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 font-medium"
      >
        Annuler
      </button>
      <button 
        type="submit"
        [disabled]="loading || formData.items.length === 0"
        class="px-4 py-2 bg-main text-white rounded-lg hover:bg-opacity-90 font-medium disabled:opacity-50 disabled:cursor-not-allowed"
      >
        @if (loading) {
          <span>Création en cours...</span>
        } @else {
          <span>Créer la collecte</span>
        }
      </button>
    </div>
  </form>
</div>