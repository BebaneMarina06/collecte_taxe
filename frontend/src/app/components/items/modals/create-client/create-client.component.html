<div class="w-full max-w-full modal-content-wrapper">
  <h2 class="text-2xl text-main font-medium">Ajout de client</h2>
  <p>Saisissez les informations du client</p>
  
  @if (error) {
    <div class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
      {{ error }}
    </div>
  }
  
  <form class="w-full grid gap-3 mt-8" (ngSubmit)="onSubmit()">
    <!-- Nom -->
    <div>
      <label for="nom" class="block text-sm/6 font-medium text-gray-900">
        Nom <sup class="text-red-500">*</sup>
      </label>
      <div class="mt-2">
        <input 
          type="text" 
          name="nom" 
          id="nom" 
          [(ngModel)]="formData.nom"
          required
          class="block w-full rounded-lg px-3 py-3 bg-background text-base text-gray-900 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main sm:text-sm/6" 
          placeholder="Nom du client"
        >
      </div>
    </div>

    <!-- Pr√©nom -->
    <div>
      <label for="prenom" class="block text-sm/6 font-medium text-gray-900">
        Pr√©nom
      </label>
      <div class="mt-2">
        <input 
          type="text" 
          name="prenom" 
          id="prenom" 
          [(ngModel)]="formData.prenom"
          class="block w-full rounded-lg px-3 py-3 bg-background text-base text-gray-900 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main sm:text-sm/6" 
          placeholder="Pr√©nom du client"
        >
      </div>
    </div>

    <!-- Type de contact -->
    <div class="grid grid-cols-2 gap-2 h-[50px] rounded-lg bg-main/10 p-[5px] mt-5">
      <button 
        type="button" 
        (click)="onToggleActiveEmail(false)" 
        [class.active]="!activeEmail"
        class="[&.active]:bg-main [&.active]:text-white text-gray-700 rounded-lg"
      >
        Contact
      </button>
      <button 
        type="button" 
        (click)="onToggleActiveEmail(true)" 
        [class.active]="activeEmail"
        class="[&.active]:bg-main [&.active]:text-white text-gray-700 rounded-lg"
      >
        E-mail
      </button>
    </div>

    <!-- T√©l√©phone ou Email -->
    @if (activeEmail) {
      <div>
        <label for="email" class="block text-sm/6 font-medium text-gray-900">
          Email
        </label>
        <div class="mt-2">
          <input 
            type="email" 
            name="email" 
            id="email"
            [(ngModel)]="formData.email"
            class="block w-full rounded-lg px-3 py-3 bg-background text-base text-gray-900 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main sm:text-sm/6" 
            placeholder="user@gmail.com"
          >
        </div>
      </div>
    } @else {
      <div>
        <label for="telephone" class="block text-sm/6 font-medium text-gray-900">
          T√©l√©phone <sup class="text-red-500">*</sup>
        </label>
        <div class="mt-2 grid grid-cols-1 items-center">
          <input 
            type="tel" 
            name="telephone" 
            id="telephone"
            [(ngModel)]="formData.telephone"
            required
            class="col-start-1 row-start-1 block w-full rounded-md bg-background py-3 pl-10 pr-3 text-base text-gray-900 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main sm:pl-9 sm:text-sm/6" 
            placeholder="+241 066 00 00 00"
          >
          <svg class="pointer-events-none col-start-1 row-start-1 ml-3 size-5 self-center text-gray-400 sm:size-4" xmlns="http://www.w3.org/2000/svg">
            <rect fill="#3a75c4" width="16" height="15"/>
            <rect fill="#fcd116" width="16" height="10"/>
            <rect fill="#009e60" width="16" height="5"/>
          </svg>
        </div>
      </div>
    }

    <!-- Type de contribuable -->
    <div>
      <label for="type_contribuable" class="block text-sm/6 font-medium text-gray-900">
        Type de contribuable <sup class="text-red-500">*</sup>
      </label>
      <div class="mt-2">
        <select 
          name="type_contribuable" 
          id="type_contribuable"
          [(ngModel)]="formData.type_contribuable_id"
          required
          class="block w-full rounded-lg px-3 py-3 bg-background text-base text-gray-900 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main sm:text-sm/6"
        >
          <option value="0">S√©lectionner un type</option>
          @for (type of typesContribuables; track type.id) {
            <option [value]="type.id">{{ type.nom }}</option>
          }
        </select>
      </div>
    </div>

    <!-- Zone -->
    <div>
      <label for="zone" class="block text-sm/6 font-medium text-gray-900">
        Zone
      </label>
      <div class="mt-2">
        <select 
          name="zone" 
          id="zone"
          [ngModel]="selectedZoneId"
          (ngModelChange)="onZoneChange($event)"
          class="block w-full rounded-lg px-3 py-3 bg-background text-base text-gray-900 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main sm:text-sm/6"
        >
          <option [ngValue]="null">@if (loadingZones) { Chargement des zones... } @else { S√©lectionner une zone }</option>
          @for (zone of zones; track zone.id) {
            <option [ngValue]="zone.id">{{ zone.nom || zone.code || 'Zone ' + zone.id }}</option>
          }
          @empty {
            @if (!loadingZones) {
              <option disabled>Aucune zone disponible</option>
            }
          }
        </select>
      </div>
    </div>

    <!-- Quartier -->
    <div>
      <label for="quartier" class="block text-sm/6 font-medium text-gray-900">
        Quartier <sup class="text-red-500">*</sup>
      </label>
      <div class="mt-2">
        <select 
          name="quartier" 
          id="quartier"
          [(ngModel)]="formData.quartier_id"
          required
          [disabled]="!selectedZoneId || quartiers.length === 0"
          class="block w-full rounded-lg px-3 py-3 bg-background text-base text-gray-900 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main sm:text-sm/6 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <option value="0">@if (loadingQuartiers) { Chargement des quartiers... } @else if (!selectedZoneId) { S√©lectionnez d'abord une zone } @else if (quartiers.length === 0) { Aucun quartier disponible } @else { S√©lectionner un quartier }</option>
          @for (quartier of quartiers; track quartier.id) {
            <option [value]="quartier.id">{{ quartier.nom || quartier.code || 'Quartier ' + quartier.id }}</option>
          }
        </select>
      </div>
    </div>

    <!-- Collecteur -->
    <div>
      <label for="collecteur" class="block text-sm/6 font-medium text-gray-900">
        Collecteur <sup class="text-red-500">*</sup>
      </label>
      <div class="mt-2">
        <select 
          name="collecteur" 
          id="collecteur"
          [(ngModel)]="formData.collecteur_id"
          required
          class="block w-full rounded-lg px-3 py-3 bg-background text-base text-gray-900 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main sm:text-sm/6"
        >
          <option value="0">S√©lectionner un collecteur</option>
          @for (collecteur of collecteurs; track collecteur.id) {
            <option [value]="collecteur.id">{{ collecteur.nom }} {{ collecteur.prenom }}</option>
          }
        </select>
      </div>
    </div>

    <!-- Nom de l'activit√© -->
    <div>
      <label for="nom_activite" class="block text-sm/6 font-medium text-gray-900">
        Nom de l'activit√© / Commerce
      </label>
      <div class="mt-2">
        <input 
          type="text" 
          name="nom_activite" 
          id="nom_activite"
          [(ngModel)]="formData.nom_activite"
          class="block w-full rounded-lg px-3 py-3 bg-background text-base text-gray-900 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main sm:text-sm/6" 
          placeholder="Ex: √âpicerie du Centre, Restaurant Chez Marie"
        >
        <p class="mt-1 text-xs text-gray-500">
          Nom commercial ou nom de l'√©tablissement
        </p>
      </div>
    </div>

    <!-- Photo du lieu -->
    <div>
      <label for="photo" class="block text-sm/6 font-medium text-gray-900">
        Photo du lieu
      </label>
      <div class="mt-2">
        <input 
          type="file" 
          name="photo" 
          id="photo"
          accept="image/*"
          (change)="onPhotoSelected($event)"
          class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-main file:text-white hover:file:bg-main/90"
        >
        @if (photoPreview) {
          <div class="mt-2">
            <img [src]="photoPreview" alt="Aper√ßu" class="max-w-full h-32 object-cover rounded-lg border border-gray-300">
            <button 
              type="button"
              (click)="removePhoto()"
              class="mt-1 text-xs text-red-600 hover:text-red-800"
            >
              Supprimer la photo
            </button>
          </div>
        }
        <p class="mt-1 text-xs text-gray-500">
          Photo de la fa√ßade ou du lieu d'activit√© (optionnel)
        </p>
      </div>
    </div>

    <!-- Adresse -->
    <div>
      <label for="adresse" class="block text-sm/6 font-medium text-gray-900">
        Adresse compl√®te <sup class="text-red-500">*</sup>
      </label>
      <div class="mt-2">
        <input 
          type="text" 
          name="adresse" 
          id="adresse"
          [(ngModel)]="formData.adresse"
          required
          class="block w-full rounded-lg px-3 py-3 bg-background text-base text-gray-900 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main sm:text-sm/6" 
          placeholder="Ex: Avenue L√©on Mba, N¬∞ 45, Libreville"
        >
        <p class="mt-1 text-xs text-gray-500">
          Indiquez l'adresse compl√®te : rue, num√©ro, quartier, ville
        </p>
      </div>
    </div>

    <!-- G√©olocalisation GPS (Optionnelle) -->
    <div>
      <label class="block text-sm/6 font-medium text-gray-900 mb-2">
        G√©olocalisation GPS <span class="text-xs font-normal text-gray-500">(Optionnelle)</span>
      </label>
      <div class="mb-2 p-3 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-800">
        <p class="font-medium mb-1">üí° Pourquoi la g√©olocalisation GPS ?</p>
        <ul class="list-disc list-inside space-y-1 text-blue-700">
          <li>Optimisation des tourn√©es des collecteurs</li>
          <li>Calcul de distances et temps de trajet</li>
          <li>Visualisation sur une carte</li>
          <li>Localisation pr√©cise en cas de besoin</li>
        </ul>
        <p class="mt-2 text-blue-600">
          <strong>Note :</strong> L'adresse textuelle et le quartier sont suffisants pour la plupart des cas. 
          Le GPS est utile mais optionnel.
        </p>
      </div>
      <div class="space-y-2">
        @if (canGetLocation) {
          <div class="flex gap-2">
            <button 
              type="button"
              (click)="getCurrentLocation()"
              [disabled]="geolocationStatus === 'loading'"
              class="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-main text-white rounded-lg hover:bg-main/90 disabled:opacity-50 disabled:cursor-not-allowed transition"
            >
              @if (geolocationStatus === 'loading') {
                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Localisation...</span>
              } @else {
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span>Obtenir ma position</span>
              }
            </button>
            @if (formData.latitude !== undefined && formData.longitude !== undefined) {
              <button 
                type="button"
                (click)="clearLocation()"
                class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition"
                title="Effacer la position"
              >
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            }
          </div>
        } @else {
          <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
            La g√©olocalisation n'est pas disponible dans votre navigateur.
          </div>
        }

        @if (geolocationError) {
          <div class="p-2 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700">
            {{ geolocationError }}
          </div>
        }

        @if (formData.latitude !== undefined && formData.longitude !== undefined) {
          <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
            <div class="flex items-center gap-2 text-sm text-green-800 mb-2">
              <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="font-medium">Position enregistr√©e</span>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div>
                <span class="text-gray-600">Latitude:</span>
                <span class="ml-1 font-mono text-gray-800">{{ formData.latitude | number:'1.6-8' }}</span>
              </div>
              <div>
                <span class="text-gray-600">Longitude:</span>
                <span class="ml-1 font-mono text-gray-800">{{ formData.longitude | number:'1.6-8' }}</span>
              </div>
            </div>
            <a 
              [href]="'https://www.google.com/maps?q=' + formData.latitude + ',' + formData.longitude" 
              target="_blank"
              class="mt-2 inline-flex items-center gap-1 text-xs text-main hover:text-main/80 underline"
            >
              <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
              Voir sur Google Maps
            </a>
          </div>
        } @else {
          <div class="p-2 bg-gray-50 border border-gray-200 rounded-lg text-xs text-gray-600">
            Aucune position enregistr√©e. Cliquez sur "Obtenir ma position" pour capturer les coordonn√©es GPS.
          </div>
        }

        <!-- Saisie manuelle optionnelle -->
        <details class="mt-2">
          <summary class="text-sm text-gray-600 cursor-pointer hover:text-gray-800">
            Saisir manuellement les coordonn√©es
          </summary>
          <div class="mt-2 grid grid-cols-2 gap-2">
            <div>
              <label for="latitude" class="block text-xs font-medium text-gray-700 mb-1">Latitude</label>
              <input 
                type="number" 
                step="any"
                name="latitude" 
                id="latitude"
                [(ngModel)]="formData.latitude"
                class="block w-full rounded-lg px-2 py-1.5 bg-background text-sm text-gray-900 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main" 
                placeholder="0.000000"
              >
            </div>
            <div>
              <label for="longitude" class="block text-xs font-medium text-gray-700 mb-1">Longitude</label>
              <input 
                type="number" 
                step="any"
                name="longitude" 
                id="longitude"
                [(ngModel)]="formData.longitude"
                class="block w-full rounded-lg px-2 py-1.5 bg-background text-sm text-gray-900 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main" 
                placeholder="0.000000"
              >
            </div>
          </div>
        </details>
      </div>
    </div>

    <!-- Num√©ro d'identification -->
    <div>
      <label for="numero_identification" class="block text-sm/6 font-medium text-gray-900">
        Num√©ro d'identification
      </label>
      <div class="mt-2">
        <input 
          type="text" 
          name="numero_identification" 
          id="numero_identification"
          [(ngModel)]="formData.numero_identification"
          class="block w-full rounded-lg px-3 py-3 bg-background text-base text-gray-900 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-main sm:text-sm/6" 
          placeholder="Num√©ro d'identification"
        >
      </div>
    </div>

    <!-- Attribution de taxes -->
    <div>
      <label class="block text-sm/6 font-medium text-gray-900 mb-2">
        Taxes √† attribuer <span class="text-xs font-normal text-gray-500">(Optionnel)</span>
      </label>
      <div class="mt-2 p-3 bg-gray-50 border border-gray-200 rounded-lg max-h-48 overflow-y-auto">
        @if (taxes.length === 0) {
          <p class="text-sm text-gray-500">Aucune taxe disponible</p>
        } @else {
          <div class="space-y-2">
            @for (taxe of taxes; track taxe.id) {
              <label class="flex items-center gap-2 p-2 rounded-lg hover:bg-white cursor-pointer transition">
                <input 
                  type="checkbox" 
                  [checked]="isTaxeSelected(taxe.id)"
                  (change)="onTaxeToggle(taxe.id)"
                  class="w-4 h-4 text-main border-gray-300 rounded focus:ring-main"
                >
                <div class="flex-1">
                  <span class="text-sm font-medium text-gray-900">{{ taxe.nom }}</span>
                  @if (taxe.description) {
                    <p class="text-xs text-gray-500 mt-0.5">{{ taxe.description }}</p>
                  }
                  <div class="flex items-center gap-2 mt-1">
                    <span class="text-xs font-semibold text-main">
                      {{ taxe.montant ? (taxe.montant | number:'1.0-0') + ' FCFA' : 'Variable' }}
                    </span>
                    @if (taxe.periodicite) {
                      <span class="text-xs text-gray-500">‚Ä¢ {{ taxe.periodicite }}</span>
                    }
                  </div>
                </div>
              </label>
            }
          </div>
          @if (selectedTaxes.length > 0) {
            <div class="mt-3 pt-3 border-t border-gray-200">
              <p class="text-xs text-gray-600">
                <strong>{{ selectedTaxes.length }}</strong> taxe{{ selectedTaxes.length > 1 ? 's' : '' }} s√©lectionn√©e{{ selectedTaxes.length > 1 ? 's' : '' }}
              </p>
            </div>
          }
        }
      </div>
      <p class="mt-1 text-xs text-gray-500">
        S√©lectionnez les taxes √† attribuer √† ce contribuable. Vous pourrez en ajouter d'autres plus tard.
      </p>
    </div>

    <!-- Boutons -->
    <div class="grid grid-cols-2 gap-3 mt-5">
      <button 
        type="button"
        (click)="resetForm()"
        class="rounded-lg py-2 border-main border-2 text-main font-medium hover:bg-main/10"
      >
        Annuler
      </button>
      <button 
        type="submit"
        [disabled]="loading"
        class="rounded-lg py-2 bg-main text-white font-medium hover:bg-main/90 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        @if (loading) {
          <span>Enregistrement...</span>
        } @else {
          <span>Enregistrer</span>
        }
      </button>
    </div>
  </form>
</div>
